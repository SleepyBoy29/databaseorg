SET COLSEP '|'
set colsep '|'
SET LINE 140
SET DEFINE ON
SET VERIFY OFF
COLUMN WHAT FORMAT A40
COLUMN USERNAME FORMAT A15
COLUMN SERIAL# FORMAT 99999
COLUMN MACHINE FORMAT A10
COLUMN OSUSER FORMAT A15
COLUMN SID FORMAT 9999
COLUMN SPID FORMAT 9999
COLUMN STATUS FORMAT A10
COLUMN PROGRAM FORMAT A15
COLUMN SER# FORMAT 99999
COLUMN KILL FORMAT A40
SET LINESIZE 140

SELECT S.SID,S.SERIAL#,P.SPID "SPID",R.JOB,S.USERNAME,S.STATUS,S.OSUSER,S.MACHINE,J.JOB,R.THIS_DATE
FROM V$SESSION S,V$PROCESS P,DBA_JOBS J, DBA_JOBS_RUNNING R
WHERE S.PADDR=P.ADDR
AND J.JOB=R.JOB
AND J.LOG_USER=S.USERNAME
and r.sid=s.sid
ORDER BY S.status;

SELECT 'EXEC DBMS_JOB.BROKEN('|| R.JOB ||',TRUE);' || chr(10) || 'COMMIT;' AS KILL_JOB,S.SID,S.USERNAME
FROM DBA_JOBS J, DBA_JOBS_RUNNING R, V$SESSION S
WHERE J.JOB=R.JOB
AND R.SID=S.SID
AND S.SID=R.SID
AND S.sid=&&sid;

SELECT 'ALTER SYSTEM KILL SESSION '''|| b.SID || ',' || b.SERial#||''';' kill,
a.spid pid,
SUBSTR(b.SID,1,5) SID,
SUBSTR(b.serial#,1,5) ser#,
SUBSTR(b.machine,1,6) box,
SUBSTR(b.username,1,10) username,
SUBSTR(b.osuser,1,8) os_user,
SUBSTR(b.program,1,30) program
FROM
v$session b,
v$process a
WHERE
b.paddr = a.addr
AND TYPE='USER'
and sid=&sid
ORDER BY spid
;

UNDEFINE SID;